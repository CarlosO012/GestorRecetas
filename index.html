<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Parámetros de Moldeo</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js">
// === URL del Apps Script ===
const API_URL = "https://script.google.com/macros/s/AKfycbx8lxHKSLEjCGizQBsn-qMys9CWE9GJA-pOSVxCrYTZFt2nKZ-0cRZMIVVBaoVSxirF/exec";

// === Guardar libro en la nube ===
function saveBookOnline(book) {
    fetch(API_URL, {
        method: "POST",
        body: JSON.stringify(book),
        headers: { "Content-Type": "application/json" }
    })
    .then(res => res.json())
    .then(() => {
        alert("Libro guardado en Google Drive");
        showScreen('homeScreen');
        loadSavedBooks(); // recargar lista
    })
    .catch(err => console.error("Error al guardar:", err));
}

// === Cargar todos los libros ===
function loadSavedBooks() {
    fetch(API_URL)
        .then(res => res.json())
        .then(books => {
            const booksList = document.getElementById('booksList');

            if (books.length === 0) {
                booksList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-folder-open"></i>
                        <p>No hay libros guardados aún</p>
                    </div>
                `;
                return;
            }

            booksList.innerHTML = '';
            [...books].reverse().forEach(book => {
                const bookElement = document.createElement('div');
                bookElement.className = 'book-item';
                bookElement.innerHTML = `
                    <h4>${book.product.name}</h4>
                    <p><strong>Máquina:</strong> ${book.product.machine}</p>
                    <p><strong>Lote:</strong> ${book.product.lot}</p>
                    <p><strong>Fecha:</strong> ${new Date(book.product.date).toLocaleDateString()}</p>
                    <p><strong>Autor:</strong> ${book.product.author}</p>
                    <p><strong>Páginas:</strong> ${book.pages.length}</p>
                    <div class="book-actions">
                        <button class="btn-small btn-view" onclick="viewBook(${book.id})">Ver</button>
                        <button class="btn-small btn-download" onclick="downloadBookExcel(${book.id})">Descargar</button>
                        <button class="btn-small btn-view" onclick="startEditBook(${book.id})"><i class="fas fa-pen"></i> Editar</button>
                        <button class="btn-small btn-delete" onclick="deleteBook(${book.id})">Eliminar</button>
                    </div>
                `;
                booksList.appendChild(bookElement);
            });
        })
        .catch(err => console.error("Error al cargar libros:", err));
}

// === Eliminar libro ===
function deleteBook(id) {
    if (!confirm("¿Seguro que quieres eliminar este libro?")) return;

    fetch(API_URL + "?id=" + id, { method: "DELETE" })
        .then(res => res.json())
        .then(() => {
            alert("Libro eliminado");
            loadSavedBooks();
        })
        .catch(err => console.error("Error al eliminar:", err));
}

// === Terminar creación/edición de libro ===
function finishBookCreation() {
    const completedPages = currentPages.filter(page => page.completed);

    if (completedPages.length === 0) {
        alert('Debe completar al menos una página antes de guardar el libro');
        return;
    }

    const newBookData = {
        id: editingBookId || Date.now(),
        product: currentProduct,
        pages: completedPages,
        createdAt: new Date().toISOString()
    };

    saveBookOnline(newBookData);
}

</script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 480px;
            margin: 0 auto;
            background: #fff;
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.3);
            position: relative;
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .screen {
            display: none;
            padding: 20px;
            min-height: calc(100vh - 100px);
        }

        .screen.active {
            display: block;
            animation: slideIn 0.3s ease-in-out;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .search-container {
            margin-bottom: 30px;
        }

        .search-box {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .search-box:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.3);
        }

        .machine-buttons {
            display: grid;
            gap: 15px;
            margin-bottom: 10px;
        }

        .machine-btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 20px;
            border-radius: 15px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }

        .machine-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
        }

        .machine-btn.nissei {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
        }

        .machine-btn.nissei:hover {
            box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #2c3e50;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #3498db;
        }

        .btn {
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 20px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #95a5a6, #7f8c8d);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
        }

        .btn-add {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin: 5px 0 20px 0;
        }

        .page-tabs {
            display: flex;
            overflow-x: auto;
            gap: 10px;
            margin-bottom: 20px;
            padding-bottom: 10px;
        }

        .page-tab {
            min-width: 120px;
            padding: 10px 15px;
            background: #ecf0f1;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            position: relative;
        }

        .page-tab.active {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .page-tab.completed {
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
        }

        .page-status {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #27ae60;
            color: white;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .parameter-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .parameter-table th {
            background: linear-gradient(135deg, #34495e, #2c3e50);
            color: white;
            padding: 15px 10px;
            font-weight: bold;
            text-align: center;
        }

        .parameter-table td {
            padding: 12px 10px;
            border-bottom: 1px solid #ecf0f1;
            text-align: center;
        }

        .parameter-input {
            width: 100%;
            border: 1px solid #ddd;
            padding: 8px;
            border-radius: 4px;
            font-size: 14px;
        }

        .magnitude-select {
            width: 100%;
            border: 1px solid #ddd;
            padding: 8px;
            border-radius: 4px;
            font-size: 14px;
        }

        .delete-row {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .saved-books {
            margin-top: 30px;
        }

        .book-item {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #3498db;
        }

        .book-item h4 {
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .book-item p {
            color: #7f8c8d;
            font-size: 14px;
            margin-bottom: 3px;
        }

        .book-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .btn-small {
            padding: 8px 15px;
            font-size: 14px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-view {
            background: #3498db;
            color: white;
        }

        .btn-delete {
            background: #e74c3c;
            color: white;
        }

        .btn-download {
            background: #27ae60;
            color: white;
        }

        .back-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255,255,255,0.9);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
        }

        .machine-title {
            background: linear-gradient(135deg, #8e44ad, #9b59b6);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #7f8c8d;
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            text-align: center;
        }

        .add-row-btn {
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px 0;
            font-size: 14px;
        }

        .page-summary {
            background: #ecf0f1;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .page-summary h4 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .parameter-count {
            color: #7f8c8d;
            font-size: 14px;
        }

        @media (max-width: 480px) {
            .container {
                max-width: 100%;
            }
            
            .parameter-table {
                font-size: 12px;
            }
            
            .parameter-table th,
            .parameter-table td {
                padding: 8px 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fa fa-flask"></i> Gestor De Parametros</h1>
            <p>Parametros Para Envases Y Tapaderas</p>
        </div>

        <button class="back-btn" id="backBtn" style="display: none;" onclick="goBack()">
            <i class="fas fa-arrow-left"></i>
        </button>

        <!-- Pantalla Principal -->
        <div class="screen active" id="homeScreen">
            <div class="search-container">
                <input type="text" class="search-box" placeholder="Buscar libros de parámetros..." id="searchInput">
            </div>

            <div class="machine-buttons" id="machineButtons">
                <!-- Botones de máquinas dinámicos -->
            </div>
            <button class="btn-add" id="btnAddMachine"><i class="fas fa-plus"></i> Agregar máquina</button>

            <div class="saved-books" id="savedBooks">
                <h3>Libros Guardados</h3>
                <div id="booksList"></div>
            </div>
        </div>

        <!-- Pantalla de Información del Producto -->
        <div class="screen" id="productScreen">
            <h2>Información del Producto</h2>
            <div class="machine-title" id="selectedMachineTitle"></div>
            
            <div class="form-group">
                <label for="productName">Nombre del Producto:</label>
                <input type="text" id="productName" class="form-input" required>
            </div>

            <div class="form-group">
                <label for="productDate">Fecha:</label>
                <input type="date" id="productDate" class="form-input" required>
            </div>

            <div class="form-group">
                <label for="productLot">Lote:</label>
                <input type="text" id="productLot" class="form-input" required>
            </div>

            <div class="form-group">
                <label for="productAuthor">Autor:</label>
                <input type="text" id="productAuthor" class="form-input" required>
            </div>

            <button class="btn" onclick="saveProductInfo()">
                <i class="fas fa-save"></i> Guardar y Continuar
            </button>
        </div>

        <!-- Pantalla de Gestión de Páginas -->
        <div class="screen" id="pagesManagementScreen">
            <div class="machine-title" id="managementTitle"></div>
            
            <div id="pagesOverview"></div>

            <button class="btn" onclick="showAddPageModal()">
                <i class="fas fa-plus"></i> Agregar Nueva Página
            </button>

            <button class="btn btn-secondary" onclick="finishBookCreation()" id="finishBookBtn" style="display: none;">
                <i class="fas fa-check"></i> Finalizar y Guardar Libro
            </button>
        </div>

        <!-- Pantalla de Parámetros -->
        <div class="screen" id="parametersScreen">
            <div class="machine-title" id="parametersTitle"></div>
            
            <div id="currentPageContent">
                <table class="parameter-table" id="parametersTable">
                    <thead>
                        <tr>
                            <th>Parámetro</th>
                            <th>Valor</th>
                            <th>Magnitud</th>
                            <th>Acción</th>
                        </tr>
                    </thead>
                    <tbody id="parametersBody">
                    </tbody>
                </table>
                
                <button class="add-row-btn" onclick="addParameterRow()">
                    <i class="fas fa-plus"></i> Agregar Parámetro
                </button>
            </div>

            <button class="btn" onclick="saveCurrentPage()">
                <i class="fas fa-save"></i> Guardar Página
            </button>
        </div>

        <!-- Pantalla ver libro (solo visualización y modo edición) -->
        <div class="screen" id="bookViewScreen">
            <div class="machine-title" id="bookViewTitle"></div>
            <div id="bookViewInfo" class="page-summary"></div>
            <div id="bookViewPages"></div>
            <div class="book-actions" style="margin-top:15px;">
                <button class="btn btn-warning" id="btnEditBook"><i class="fas fa-pen"></i> Editar libro</button>
                <button class="btn btn-secondary" onclick="goHome()"><i class="fas fa-home"></i> Volver al inicio</button>
            </div>
        </div>
    </div>

    <!-- Modal para agregar página -->
    <div class="modal" id="addPageModal">
        <div class="modal-content">
            <h3>Agregar Nueva Página</h3>
            <div class="form-group">
                <label for="pageTitle">Título de la página:</label>
                <input type="text" id="pageTitle" class="form-input" placeholder="Ej: Preformas, Soplado, etc.">
            </div>
            <button class="btn" onclick="createNewPage()">Crear Página</button>
            <button class="btn btn-secondary" onclick="closeAddPageModal()">Cancelar</button>
        </div>
    </div>

    <!-- Modal para agregar máquina -->
    <div class="modal" id="addMachineModal">
        <div class="modal-content">
            <h3>Agregar nueva máquina</h3>
            <div class="form-group">
                <label for="machineNameInput">Nombre de la máquina:</label>
                <input type="text" id="machineNameInput" class="form-input" placeholder="Ej: Nissei-Asb 12M">
            </div>
            <button class="btn" onclick="createMachine()">Agregar</button>
            <button class="btn btn-secondary" onclick="closeAddMachineModal()">Cancelar</button>
        </div>
    </div>

    <script>
        // Variables globales
        let currentMachine = '';
        let currentProduct = {};
        let currentPages = [];
        let currentPageIndex = -1;
        let editingPageIndex = -1;
        let screenHistory = [];
        let editingBookId = null; // Si no es null, estamos editando un libro existente

        // ====== Gestión dinámica de máquinas ======
        function ensureDefaultMachines() {
            const stored = JSON.parse(localStorage.getItem('machines') || '[]');
            if (stored.length === 0) {
                const defaults = ['Nissei-Asb 12M', '70DPH'];
                localStorage.setItem('machines', JSON.stringify(defaults));
            }
        }

        function renderMachines() {
            const list = document.getElementById('machineButtons');
            list.innerHTML = '';
            const machines = JSON.parse(localStorage.getItem('machines') || '[]');
            machines.forEach(name => {
                const btn = document.createElement('button');
                // Mantener el estilo original: 70DPH usa .nissei (rojo), otros usan default (azul)
                btn.className = 'machine-btn' + (name.trim().toLowerCase() === '70dph' ? ' nissei' : '');
                btn.innerHTML = (name.trim().toLowerCase() === '70dph')
                    ? '<i class="fas fa-industry"></i> ' + name
                    : '<i class="fas fa-cog"></i> ' + name;
                btn.onclick = () => selectMachine(name);
                list.appendChild(btn);
            });
        }

        // Abrir/Cerrar modal de máquina
        function openAddMachineModal() {
            document.getElementById('addMachineModal').style.display = 'flex';
            document.getElementById('machineNameInput').value = '';
            document.getElementById('machineNameInput').focus();
        }
        function closeAddMachineModal() {
            document.getElementById('addMachineModal').style.display = 'none';
        }
        function createMachine() {
            const name = (document.getElementById('machineNameInput').value || '').trim();
            if (!name) { alert('Ingresa un nombre'); return; }
            const machines = JSON.parse(localStorage.getItem('machines') || '[]');
            if (machines.includes(name)) { alert('Esa máquina ya existe'); return; }
            machines.push(name);
            localStorage.setItem('machines', JSON.stringify(machines));
            closeAddMachineModal();
            renderMachines();
        }

        // ====== Fin gestión dinámica de máquinas ======

        // Cargar datos al inicio
        document.addEventListener('DOMContentLoaded', function() {
            ensureDefaultMachines();
            renderMachines();
            loadSavedBooks();
            setupSearch();
            setCurrentDate();
            document.getElementById('btnAddMachine').addEventListener('click', openAddMachineModal);
        });

        function setCurrentDate() {
            const today = new Date();
            const dateString = today.toISOString().split('T')[0];
            document.getElementById('productDate').value = dateString;
        }

        // Funciones de navegación
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
            
            if (screenId !== 'homeScreen') {
                document.getElementById('backBtn').style.display = 'block';
                if (screenHistory[screenHistory.length - 1] !== screenId) {
                    screenHistory.push(screenId);
                }
            } else {
                document.getElementById('backBtn').style.display = 'none';
                screenHistory = [];
            }
        }

        function goBack() {
            screenHistory.pop(); // Remove current screen
            const previousScreen = screenHistory.length > 0 ? screenHistory[screenHistory.length - 1] : 'homeScreen';
            
            if (previousScreen === 'homeScreen') {
                showScreen('homeScreen');
                resetCurrentData();
            } else {
                showScreen(previousScreen);
            }
        }

        function goHome() {
            showScreen('homeScreen');
            resetCurrentData();
            loadSavedBooks();
            renderMachines();
        }

        function resetCurrentData() {
            currentMachine = '';
            currentProduct = {};
            currentPages = [];
            currentPageIndex = -1;
            editingPageIndex = -1;
            editingBookId = null;
            document.getElementById('selectedMachineTitle').textContent = '';
            document.getElementById('managementTitle').textContent = '';
            document.getElementById('parametersTitle').textContent = '';
            document.getElementById('pagesOverview').innerHTML = '';
            document.getElementById('parametersBody').innerHTML = '';
        }

        // Selección de máquina
        function selectMachine(machine) {
            currentMachine = machine;
            document.getElementById('selectedMachineTitle').textContent = machine;
            showScreen('productScreen');
        }

        // Guardar información del producto
        function saveProductInfo() {
            const productName = document.getElementById('productName').value.trim();
            const productDate = document.getElementById('productDate').value;
            const productLot = document.getElementById('productLot').value.trim();
            const productAuthor = document.getElementById('productAuthor').value.trim();

            if (!productName || !productDate || !productLot || !productAuthor) {
                alert('Por favor, complete todos los campos');
                return;
            }

            currentProduct = {
                name: productName,
                date: productDate,
                lot: productLot,
                author: productAuthor,
                machine: currentMachine
            };

            document.getElementById('managementTitle').textContent = `${currentMachine} - ${productName}`;
            showPagesManagement();
        }

        // Mostrar gestión de páginas
        function showPagesManagement() {
            showScreen('pagesManagementScreen');
            renderPagesOverview();
        }

        function renderPagesOverview() {
            const container = document.getElementById('pagesOverview');
            
            if (currentPages.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-file-plus"></i>
                        <p>No hay páginas creadas aún</p>
                        <p>Agregue su primera página para comenzar</p>
                    </div>
                `;
                document.getElementById('finishBookBtn').style.display = 'none';
                return;
            }

            container.innerHTML = '<h3>Páginas del Libro</h3>';
            
            currentPages.forEach((page, index) => {
                const pageDiv = document.createElement('div');
                pageDiv.className = 'page-summary';
                pageDiv.innerHTML = `
                    <h4>${page.title}</h4>
                    <div class="parameter-count">
                        ${page.parameters ? page.parameters.length : 0} parámetros
                        ${page.completed ? '<i class="fas fa-check" style="color: #27ae60; margin-left: 10px;"></i>' : '<i class="fas fa-edit" style="color: #f39c12; margin-left: 10px;"></i>'}
                    </div>
                    <div class="book-actions" style="margin-top: 10px;">
                        <button class="btn-small btn-view" onclick="editPage(${index})">
                            ${page.completed ? 'Ver/Editar' : 'Completar'}
                        </button>
                        <button class="btn-small btn-delete" onclick="deletePage(${index})">Eliminar</button>
                    </div>
                `;
                container.appendChild(pageDiv);
            });

            // Mostrar botón de finalizar si hay páginas completas
            const hasCompletedPages = currentPages.some(page => page.completed);
            document.getElementById('finishBookBtn').style.display = hasCompletedPages ? 'block' : 'none';
        }

        // Modal de nueva página
        function showAddPageModal() {
            document.getElementById('addPageModal').style.display = 'flex';
            document.getElementById('pageTitle').focus();
        }

        function closeAddPageModal() {
            document.getElementById('addPageModal').style.display = 'none';
            document.getElementById('pageTitle').value = '';
        }

        function createNewPage() {
            const title = document.getElementById('pageTitle').value.trim();
            if (!title) {
                alert('Por favor, ingrese un título para la página');
                return;
            }

            const newPage = {
                title: title,
                parameters: [],
                completed: false
            };

            currentPages.push(newPage);
            editingPageIndex = currentPages.length - 1;
            
            closeAddPageModal();
            editPage(editingPageIndex);
        }

        // Editar página
        function editPage(index) {
            editingPageIndex = index;
            document.getElementById('parametersTitle').textContent = 
                `${currentMachine} - ${currentProduct.name} - ${currentPages[index].title}`;
            
            showScreen('parametersScreen');
            renderParametersTable();
        }

        function renderParametersTable() {
            const tbody = document.getElementById('parametersBody');
            tbody.innerHTML = '';

            if (editingPageIndex >= 0 && currentPages[editingPageIndex].parameters) {
                currentPages[editingPageIndex].parameters.forEach((param) => {
                    addParameterRowToTable(param.name, param.value, param.magnitude);
                });
            }

            // Agregar fila vacía si no hay parámetros
            if (tbody.children.length === 0) {
                addParameterRow();
            }
        }

        function addParameterRow() {
            addParameterRowToTable('', '', 'grados');
        }

        function addParameterRowToTable(name = '', value = '', magnitude = 'grados') {
            const tbody = document.getElementById('parametersBody');
            const row = tbody.insertRow();
            
            row.innerHTML = `
                <td><input type="text" class="parameter-input" value="${name}" placeholder="Nombre del parámetro"></td>
                <td><input type="text" class="parameter-input" value="${value}" placeholder="Valor"></td>
                <td>
                    <select class="magnitude-select">
                        <option value="grados" ${magnitude === 'grados' ? 'selected' : ''}>°C</option>
                        <option value="presion" ${magnitude === 'presion' ? 'selected' : ''}>Bar</option>
                        <option value="presionMpa" ${magnitude === 'presionMpa' ? 'selected' : ''}>Mpa</option>
                        <option value="velocidad" ${magnitude === 'velocidad' ? 'selected' : ''}>mm/s</option>
                        <option value="distancia" ${magnitude === 'distancia' ? 'selected' : ''}>mm</option>
                        <option value="fuerza" ${magnitude === 'fuerza' ? 'selected' : ''}>kN</option>
                        <option value="porcentaje" ${magnitude === 'porcentaje' ? 'selected' : ''}>%</option>
                        <option value="tiempo" ${magnitude === 'tiempo' ? 'selected' : ''}>s</option>
                        <option value="rpm" ${magnitude === 'rpm' ? 'selected' : ''}>RPM</option>
                    </select>
                </td>
                <td><button class="delete-row" onclick="deleteParameterRow(this)">✕</button></td>
            `;
        }

        function deleteParameterRow(button) {
            const row = button.closest('tr');
            row.remove();
        }

        // Guardar página actual
        function saveCurrentPage() {
            if (editingPageIndex < 0) return;

            const tbody = document.getElementById('parametersBody');
            const rows = tbody.querySelectorAll('tr');
            const parameters = [];

            rows.forEach(row => {
                const inputs = row.querySelectorAll('input, select');
                const name = inputs[0].value.trim();
                const value = inputs[1].value.trim();
                const magnitude = inputs[2].value;

                if (name && value) {
                    parameters.push({ name, value, magnitude });
                }
            });

            if (parameters.length === 0) {
                alert('Por favor, agregue al menos un parámetro antes de guardar la página');
                return;
            }

            currentPages[editingPageIndex].parameters = parameters;
            currentPages[editingPageIndex].completed = true;

            alert('Página guardada exitosamente');
            showPagesManagement();
        }

        // Eliminar página
        function deletePage(index) {
            if (confirm('¿Está seguro de que desea eliminar esta página?')) {
                currentPages.splice(index, 1);
                renderPagesOverview();
            }
        }

        // Finalizar creación o edición del libro
        function finishBookCreation() {
            const completedPages = currentPages.filter(page => page.completed);
            
            if (completedPages.length === 0) {
                alert('Debe completar al menos una página antes de guardar el libro');
                return;
            }

            const newBookData = {
                id: editingBookId || Date.now(),
                product: currentProduct,
                pages: completedPages,
                createdAt: new Date().toISOString()
            };

            const savedBooks = JSON.parse(localStorage.getItem('parameterBooks') || '[]');

            if (editingBookId) {
                // actualizar existente
                const idx = savedBooks.findIndex(b => b.id === editingBookId);
                if (idx !== -1) savedBooks[idx] = newBookData;
                alert('Libro actualizado exitosamente');
            } else {
                // crear nuevo
                savedBooks.push(newBookData);
                alert('Libro guardado exitosamente');
            }

            localStorage.setItem('parameterBooks', JSON.stringify(savedBooks));

            showScreen('homeScreen');
            resetCurrentData();
            loadSavedBooks();
            clearProductForm();
        }

        function clearProductForm() {
            document.getElementById('productName').value = '';
            document.getElementById('productLot').value = '';
            document.getElementById('productAuthor').value = '';
            setCurrentDate();
        }

        // Cargar y mostrar libros guardados
        function loadSavedBooks() {
            const savedBooks = JSON.parse(localStorage.getItem('parameterBooks') || '[]');
            const booksList = document.getElementById('booksList');

            if (savedBooks.length === 0) {
                booksList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-folder-open"></i>
                        <p>No hay libros guardados aún</p>
                    </div>
                `;
                return;
            }

            booksList.innerHTML = '';
            // Mostrar los más recientes primero sin modificar el array original
            [...savedBooks].reverse().forEach(book => {
                const bookElement = document.createElement('div');
                bookElement.className = 'book-item';
                bookElement.innerHTML = `
                    <h4>${book.product.name}</h4>
                    <p><strong>Máquina:</strong> ${book.product.machine}</p>
                    <p><strong>Lote:</strong> ${book.product.lot}</p>
                    <p><strong>Fecha:</strong> ${new Date(book.product.date).toLocaleDateString()}</p>
                    <p><strong>Autor:</strong> ${book.product.author}</p>
                    <p><strong>Páginas:</strong> ${book.pages.length}</p>
                    <div class="book-actions">
                        <button class="btn-small btn-view" onclick="viewBook(${book.id})">Ver</button>
                        <button class="btn-small btn-download" onclick="downloadBookExcel(${book.id})">Descargar</button>
                        <button class="btn-small btn-view" onclick="startEditBook(${book.id})"><i class="fas fa-pen"></i> Editar</button>
                        <button class="btn-small btn-delete" onclick="deleteBook(${book.id})">Eliminar</button>
                    </div>
                `;
                booksList.appendChild(bookElement);
            });
        }

        // Ver libro guardado (tabla en pantalla, sin descargar)
        function viewBook(bookId) {
            const savedBooks = JSON.parse(localStorage.getItem('parameterBooks') || '[]');
            const book = savedBooks.find(b => b.id === bookId);
            if (!book) return;

            document.getElementById('bookViewTitle').textContent = `${book.product.machine} - ${book.product.name}`;
            document.getElementById('bookViewInfo').innerHTML = `
                <p><strong>Lote:</strong> ${book.product.lot}</p>
                <p><strong>Fecha:</strong> ${new Date(book.product.date).toLocaleDateString()}</p>
                <p><strong>Autor:</strong> ${book.product.author}</p>
                <p><strong>Creado:</strong> ${new Date(book.createdAt).toLocaleDateString()}</p>
            `;

            const wrapper = document.getElementById('bookViewPages');
            wrapper.innerHTML = '';
            book.pages.forEach(page => {
                const card = document.createElement('div');
                card.className = 'page-summary';
                let table = `
                    <h4>${page.title}</h4>
                    <table class="parameter-table">
                        <thead><tr><th>Parámetro</th><th>Valor</th><th>Magnitud</th></tr></thead>
                        <tbody>
                `;
                const magnitudeText = {
                    'grados': '°C',
                    'presion': 'Bar',
                    'presionMpa': 'Mpa',
                    'velocidad': 'mm/s',
                    'distancia': 'mm',
                    'fuerza': 'kN',
                    'porcentaje': '%',
                    'tiempo': 's',
                    'rpm': 'RPM'
                };
                page.parameters.forEach(p => {
                    table += `<tr><td>${p.name}</td><td>${p.value}</td><td>${magnitudeText[p.magnitude] || p.magnitude}</td></tr>`;
                });
                table += '</tbody></table>';
                card.innerHTML = table;
                wrapper.appendChild(card);
            });

            // Preparar botón Editar libro
            const btnEdit = document.getElementById('btnEditBook');
            btnEdit.onclick = () => startEditBook(bookId);

            showScreen('bookViewScreen');
        }

        // Iniciar edición de un libro guardado
        function startEditBook(bookId) {
            const savedBooks = JSON.parse(localStorage.getItem('parameterBooks') || '[]');
            const book = savedBooks.find(b => b.id === bookId);
            if (!book) return;

            editingBookId = book.id;
            currentMachine = book.product.machine;
            currentProduct = { ...book.product };
            currentPages = JSON.parse(JSON.stringify(book.pages)); // deep copy

            // Ir directo a gestión de páginas con datos cargados
            document.getElementById('selectedMachineTitle').textContent = currentMachine;
            document.getElementById('productName').value = currentProduct.name;
            document.getElementById('productDate').value = currentProduct.date;
            document.getElementById('productLot').value = currentProduct.lot;
            document.getElementById('productAuthor').value = currentProduct.author;

            document.getElementById('managementTitle').textContent = `${currentMachine} - ${currentProduct.name}`;
            showPagesManagement();
        }

        // Eliminar libro
        function deleteBook(bookId) {
            if (confirm('¿Está seguro de que desea eliminar este libro?')) {
                const savedBooks = JSON.parse(localStorage.getItem('parameterBooks') || '[]');
                const filteredBooks = savedBooks.filter(book => book.id !== bookId);
                localStorage.setItem('parameterBooks', JSON.stringify(filteredBooks));
                loadSavedBooks();
            }
        }

        // Descargar en Excel
        function downloadBookExcel(bookId) {
            const savedBooks = JSON.parse(localStorage.getItem('parameterBooks') || '[]');
            const book = savedBooks.find(b => b.id === bookId);
            if (!book) return;

            const wb = XLSX.utils.book_new();

            // Hoja de información general
            const infoData = [
                ['INFORMACIÓN DEL PRODUCTO'],
                [''],
                ['Nombre del Producto', book.product.name],
                ['Máquina', book.product.machine],
                ['Lote', book.product.lot],
                ['Fecha', new Date(book.product.date).toLocaleDateString()],
                ['Autor', book.product.author],
                ['Fecha de Creación', new Date(book.createdAt).toLocaleDateString()]
            ];

            const infoWs = XLSX.utils.aoa_to_sheet(infoData);
            XLSX.utils.book_append_sheet(wb, infoWs, 'Información');

            // Hoja para cada página de parámetros
            book.pages.forEach((page, index) => {
                const pageData = [
                    [`PARÁMETROS - ${page.title.toUpperCase()}`],
                    [''],
                    ['Parámetro', 'Valor', 'Magnitud']
                ];

                page.parameters.forEach(param => {
                    const magnitudeText = {
                        'grados': '°C',
                        'presion': 'Bar',
                        'presionMpa': 'Mpa',
                        'velocidad': 'mm/s',
                        'distancia': 'mm',
                        'fuerza': 'kN',
                        'porcentaje': '%',
                        'tiempo': 's',
                        'rpm': 'RPM'
                    };
                    
                    pageData.push([
                        param.name,
                        param.value,
                        magnitudeText[param.magnitude] || param.magnitude
                    ]);
                });

                const pageWs = XLSX.utils.aoa_to_sheet(pageData);
                XLSX.utils.book_append_sheet(wb, pageWs, page.title.substring(0, 31)); // Excel limit
            });

            // Descargar archivo
            const fileName = `${book.product.name}_${book.product.machine}_${book.product.lot}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }

        // Búsqueda
        function setupSearch() {
            const searchInput = document.getElementById('searchInput');
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const savedBooks = JSON.parse(localStorage.getItem('parameterBooks') || '[]');
                
                if (!searchTerm) {
                    loadSavedBooks();
                    return;
                }

                const filteredBooks = savedBooks.filter(book => 
                    book.product.name.toLowerCase().includes(searchTerm) ||
                    book.product.machine.toLowerCase().includes(searchTerm) ||
                    book.product.lot.toLowerCase().includes(searchTerm) ||
                    book.product.author.toLowerCase().includes(searchTerm)
                );

                const booksList = document.getElementById('booksList');
                
                if (filteredBooks.length === 0) {
                    booksList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-search"></i>
                            <p>No se encontraron resultados</p>
                        </div>
                    `;
                    return;
                }

                booksList.innerHTML = '';
                [...filteredBooks].reverse().forEach(book => {
                    const bookElement = document.createElement('div');
                    bookElement.className = 'book-item';
                    bookElement.innerHTML = `
                        <h4>${book.product.name}</h4>
                        <p><strong>Máquina:</strong> ${book.product.machine}</p>
                        <p><strong>Lote:</strong> ${book.product.lot}</p>
                        <p><strong>Fecha:</strong> ${new Date(book.product.date).toLocaleDateString()}</p>
                        <p><strong>Autor:</strong> ${book.product.author}</p>
                        <p><strong>Páginas:</strong> ${book.pages.length}</p>
                        <div class="book-actions">
                            <button class="btn-small btn-view" onclick="viewBook(${book.id})">Ver</button>
                            <button class="btn-small btn-download" onclick="downloadBookExcel(${book.id})">Descargar</button>
                            <button class="btn-small btn-view" onclick="startEditBook(${book.id})"><i class="fas fa-pen"></i> Editar</button>
                            <button class="btn-small btn-delete" onclick="deleteBook(${book.id})">Eliminar</button>
                        </div>
                    `;
                    booksList.appendChild(bookElement);
                });
            });
        }

        // Cerrar modal al hacer clic fuera
        window.onclick = function(event) {
            const modals = [document.getElementById('addPageModal'), document.getElementById('addMachineModal')];
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }

        // Enter key para crear página o máquina
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                if (document.getElementById('addPageModal').style.display === 'flex') {
                    createNewPage();
                }
                if (document.getElementById('addMachineModal').style.display === 'flex') {
                    createMachine();
                }
            }
        });
    </script>
</body>
</html>
